#!/bin/python3
import json
import sys
from pathlib import Path

TASKS_FILE = Path("./tasks.json")


def load_tasks():
    if TASKS_FILE.exists():
        with open(TASKS_FILE, "r") as f:
            return json.load(f)
    return []


def save_tasks(tasks):
    with open(TASKS_FILE, "w") as f:
        json.dump(tasks, f, indent=2)


def list_tasks(tasks):
    print("\nYour TODOs:\n")
    if not tasks:
        print("No tasks yet! ðŸŽ‰")
        return

    for task in tasks:
        status = "x" if task["completed"] else " "
        print(f"[{status}] {task['id']}. {task['title']}")


def add_task(tasks, title):
    next_id = max([t["id"] for t in tasks], default=0) + 1
    tasks.append({
        "id": next_id,
        "title": title,
        "completed": False
    })
    save_tasks(tasks)
    print(f"Added task #{next_id}")


def mark_done(tasks, task_id):
    for task in tasks:
        if task["id"] == task_id:
            task["completed"] = True
            save_tasks(tasks)
            print(f"Marked task #{task_id} as done")
            return
    print("Task ID not found")


def delete_task(tasks, task_id):
    new_tasks = [t for t in tasks if t["id"] != task_id]
    if len(new_tasks) == len(tasks):
        print("Task ID not found")
        return
    save_tasks(new_tasks)
    print(f"Deleted task #{task_id}")


def show_help():
    print("""
Usage:
  python todo.py add "Task description"
  python todo.py list
  python todo.py done <task_id>
  python todo.py delete <task_id>
  python todo.py help
""")


def main():
    tasks = load_tasks()

    if len(sys.argv) < 2:
        show_help()
        return

    command = sys.argv[1]

    if command == "add":
        if len(sys.argv) < 3:
            print("Please provide a task description")
            return
        add_task(tasks, sys.argv[2])

    elif command == "list":
        list_tasks(tasks)

    elif command == "done":
        if len(sys.argv) < 3 or not sys.argv[2].isdigit():
            print("Please provide a valid task ID")
            return
        mark_done(tasks, int(sys.argv[2]))

    elif command == "delete":
        if len(sys.argv) < 3 or not sys.argv[2].isdigit():
            print("Please provide a valid task ID")
            return
        delete_task(tasks, int(sys.argv[2]))

    else:
        show_help()


if __name__ == "__main__":
    main()

